<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { corePlugins: { preflight: false } }</script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Admin Requests â€” Fair-Share</title>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Fair-Share V1</div>
        <div class="sidebar-section-title">Navigation</div>
        <a href="{{ url_for('adminBoard') }}" class="sidebar-link">Dashboard</a>
        <a href="/camps" class="sidebar-link">View All Camps</a>
        <a href="{{ url_for('warehouse_view') }}" class="sidebar-link">View Warehouse</a>
        <a href="{{ url_for('admin_requests') }}" class="sidebar-link active">Resource Requests</a>
        <a href="{{ url_for('nday_page') }}" class="sidebar-link">N-Day Prediction</a>
        <div class="sidebar-bottom">
            <a href="/logout" class="sidebar-link">Logout</a>
        </div>
    </div>

    <div id="notif-toasts" class="notif-toast-container"></div>

    <div class="page-content">
        <h2>Resource Requests</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-msg flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if requests %}
        <div style="overflow-x: auto; margin-top: 16px;">
        <form method="POST" action="{{ url_for('approve_all_requests') }}" id="approveAllForm" style="max-width: none; background: none; border: none; box-shadow: none; padding: 0;">
            <table class="simple-table" style="min-width: 780px;">
                <thead>
                    <tr>
                        <th>Camp</th>
                        <th>Item</th>
                        <th>Remaining</th>
                        <th>Priority</th>
                        <th>Suggested</th>
                        <th>Approve Qty</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in requests %}
                    <tr>
                        <td><strong>{{ r.camp_name }}</strong></td>
                        <td>{{ r.item_type }}</td>
                        <td>{{ r.quantity_needed - r.fulfilled_quantity }}</td>
                        <td>
                            <span class="urgency-badge
                                {% if r.priority == 'critical' %}urgency-high
                                {% elif r.priority == 'high' %}urgency-high
                                {% elif r.priority == 'medium' %}urgency-medium
                                {% else %}urgency-low{% endif %}">
                                {{ r.priority }}
                            </span>
                        </td>
                        <td>{{ r.suggested_qty }}</td>
                        <td>
                            <input type="number"
                                   name="alloc_{{ r.request_id }}"
                                   value="{{ r.suggested_qty }}"
                                   min="0"
                                   max="{{ r.quantity_needed - r.fulfilled_quantity }}"
                                   data-request-id="{{ r.request_id }}"
                                   style="width: 80px;">
                        </td>
                        <td style="white-space: nowrap; min-width: 200px;">
                            <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                <button type="button" class="action-btn approve-btn"
                                        data-request-id="{{ r.request_id }}">
                                    Approve
                                </button>
                                <button type="button" class="action-btn discard-btn"
                                        data-request-id="{{ r.request_id }}"
                                        data-action="toggle-discard">
                                    Discard
                                </button>
                            </div>

                            <div class="discard-form" id="discard-form-{{ r.request_id }}" style="display:none; margin-top: 8px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <input type="text"
                                           id="note-{{ r.request_id }}"
                                           placeholder="Reason"
                                           style="width: 130px; margin: 0;"
                                           required>
                                    <button type="button" class="action-btn discard-btn"
                                            data-request-id="{{ r.request_id }}"
                                            data-action="confirm-discard"
                                            style="margin: 0;">
                                        Confirm
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        </div>
        {% else %}
        <div class="card" style="text-align:center; padding: 40px;">
            <p style="font-size: 1.1rem; color: var(--text-muted);">No pending requests at this time.</p>
        </div>
        {% endif %}
    </div>

    <script>
        document.querySelectorAll('.approve-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var qty = document.querySelector('input[name="alloc_' + requestId + '"]').value;

                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("approve_request") }}';

                var idInput = document.createElement('input');
                idInput.type = 'hidden'; idInput.name = 'request_id'; idInput.value = requestId;
                form.appendChild(idInput);

                var qtyInput = document.createElement('input');
                qtyInput.type = 'hidden'; qtyInput.name = 'allocated_quantity'; qtyInput.value = qty;
                form.appendChild(qtyInput);

                document.body.appendChild(form);
                form.submit();
            });
        });

        document.querySelectorAll('[data-action="toggle-discard"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var div = document.getElementById('discard-form-' + requestId);
                div.style.display = div.style.display === 'none' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('[data-action="confirm-discard"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var note = document.getElementById('note-' + requestId).value;

                if (!note.trim()) {
                    alert('Please provide a reason for discarding');
                    return;
                }

                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("discard_request") }}';

                var idInput = document.createElement('input');
                idInput.type = 'hidden'; idInput.name = 'request_id'; idInput.value = requestId;
                form.appendChild(idInput);

                var noteInput = document.createElement('input');
                noteInput.type = 'hidden'; noteInput.name = 'admin_note'; noteInput.value = note;
                form.appendChild(noteInput);

                document.body.appendChild(form);
                form.submit();
            });
        });
    </script>
    <script>
        // Inject TomTom API key from server (do NOT hardcode)
        window.TOMTOM_KEY = "{{ tomtom_key|e }}";
    </script>
    <script src="/static/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
