<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Requests</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        form { width: 100%; max-width: 100%; background: none; padding: 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
        .btn { padding: 8px 16px; cursor: pointer; margin: 2px; border-radius: 4px; width: auto; }
        .btn-approve { background-color: #4CAF50; color: white; border: none; }
        .btn-discard { background-color: #f44336; color: white; border: none; }
        .btn-approve-all { background-color: #2196F3; color: white; border: none; padding: 12px 24px; font-size: 16px; width: auto; border-radius: 6px; }
        .btn-approve-all:hover { background-color: #1976D2; }
        input[type="number"] { width: 80px; padding: 5px; margin-top: 0; }
        input[type="text"] { padding: 5px; width: 120px; margin-top: 0; }
        .flash-success { background-color: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .flash-error { background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .flash-warning { background-color: #fff3cd; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .priority-critical { color: #dc3545; font-weight: bold; }
        .priority-high { color: #fd7e14; font-weight: bold; }
        .priority-medium { color: #007bff; }
        .priority-low { color: #6c757d; }
        .discard-form { display: none; margin-top: 5px; }
        td button { width: auto; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Fair-Share V1</div>
        <div class="sidebar-section-title">Navigation</div>
        <a href="{{ url_for('adminBoard') }}" class="sidebar-link">Dashboard</a>
        <a href="/camps" class="sidebar-link">View All Camps</a>
        <a href="{{ url_for('warehouse_view') }}" class="sidebar-link">View Warehouse</a>
        <a href="{{ url_for('admin_requests') }}" class="sidebar-link active">Resource Requests</a>
        <a href="{{ url_for('nday_page') }}" class="sidebar-link">N-Day Prediction</a>
        <div class="sidebar-bottom">
            <a href="/logout" class="sidebar-link">Logout</a>
        </div>
    </div>

    <div class="page-content">
    <h2>Resource Requests</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if requests %}
    <!-- Single form for Approve All -->
    <form method="POST" action="{{ url_for('approve_all_requests') }}" id="approveAllForm">

        <!-- Work in Progress -->
        <!-- <button type="submit" class="btn btn-approve-all">Approve All</button> -->
        
        <table>
            <thead>
                <tr>
                    <th>Camp</th>
                    <th>Item</th>
                    <th>Remaining</th>
                    <th>Priority</th>
                    <th>Suggested</th>
                    <th>Approve Qty</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in requests %}
                <tr>
                    <td>{{ r.camp_name }}</td>
                    <td>{{ r.item_type }}</td>
                    <td>{{ r.quantity_needed - r.fulfilled_quantity }}</td>
                    <td><span class="priority-{{ r.priority }}">{{ r.priority }}</span></td>
                    <td>{{ r.suggested_qty }}</td>
                    <td>
                        <input type="number" 
                               name="alloc_{{ r.request_id }}" 
                               value="{{ r.suggested_qty }}" 
                               min="0" 
                               max="{{ r.quantity_needed - r.fulfilled_quantity }}"
                               data-request-id="{{ r.request_id }}">
                    </td>
                    <td>
                        <button type="button" class="btn btn-approve" 
                                data-request-id="{{ r.request_id }}">
                            Approve
                        </button>
                        
                        <button type="button" class="btn btn-discard"
                                data-request-id="{{ r.request_id }}"
                                data-action="toggle-discard">
                            Discard
                        </button>
                        
                        <div class="discard-form" id="discard-form-{{ r.request_id }}">
                            <input type="text" 
                                   id="note-{{ r.request_id }}" 
                                   placeholder="Reason" 
                                   required>
                            <button type="button" class="btn btn-discard" 
                                    data-request-id="{{ r.request_id }}"
                                    data-action="confirm-discard">
                                Confirm
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
    {% else %}
    <p>No pending requests.</p>
    {% endif %}

    <br>
    </div>

    <script>
        // Individual approve
        document.querySelectorAll('.btn-approve').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var qty = document.querySelector('input[name="alloc_' + requestId + '"]').value;
                
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("approve_request") }}';
                
                var idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'request_id';
                idInput.value = requestId;
                form.appendChild(idInput);
                
                var qtyInput = document.createElement('input');
                qtyInput.type = 'hidden';
                qtyInput.name = 'allocated_quantity';
                qtyInput.value = qty;
                form.appendChild(qtyInput);
                
                document.body.appendChild(form);
                form.submit();
            });
        });
        
        // Toggle discard form
        document.querySelectorAll('[data-action="toggle-discard"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var div = document.getElementById('discard-form-' + requestId);
                div.style.display = div.style.display === 'none' ? 'block' : 'none';
            });
        });
        
        // Confirm discard
        document.querySelectorAll('[data-action="confirm-discard"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var requestId = this.getAttribute('data-request-id');
                var note = document.getElementById('note-' + requestId).value;
                
                if (!note.trim()) {
                    alert('Please provide a reason for discarding');
                    return;
                }
                
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("discard_request") }}';
                
                var idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'request_id';
                idInput.value = requestId;
                form.appendChild(idInput);
                
                var noteInput = document.createElement('input');
                noteInput.type = 'hidden';
                noteInput.name = 'admin_note';
                noteInput.value = note;
                form.appendChild(noteInput);
                
                document.body.appendChild(form);
                form.submit();
            });
        });
    </script>
</body>
</html>