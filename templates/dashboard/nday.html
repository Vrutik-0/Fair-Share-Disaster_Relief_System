<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { corePlugins: { preflight: false } }</script>
    <link rel="stylesheet" href="/static/style.css">
    <title>N-Day Prediction — Fair-Share</title>
</head>

<body>

    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">Fair-Share V1</div>
        <div class="sidebar-section-title">Operations</div>
        <a href="{{ url_for('adminBoard') }}" class="sidebar-link">Dashboard</a>
        <a href="/camps" class="sidebar-link">View All Camps</a>
        <a href="{{ url_for('warehouse_view') }}" class="sidebar-link">View Warehouse</a>
        <div class="sidebar-section-title">Management</div>
        <a href="{{ url_for('admin_requests') }}" class="sidebar-link">Resource Requests</a>
        <a href="{{ url_for('nday_page') }}" class="sidebar-link active">N-Day Prediction</a>
        <div class="sidebar-bottom">
            <a href="/logout" class="sidebar-link">Logout</a>
        </div>
    </div>

    <div id="notif-toasts" class="notif-toast-container"></div>

    <div class="page-content">
        <h2>N-Day Resource Prediction</h2>
        <p style="margin-bottom: 24px;">
            XGBoost model trained on past request data to forecast next-day resource demand.
        </p>

        <!-- Prediction Section -->
        <h3>Predict Next Day</h3>
        <button id="predict-btn" class="nday-predict-btn">Predict Next Day Demand</button>

        <div id="predict-loader" class="nday-loader hidden">
            <div class="nday-spinner"></div>
            <span>Running prediction model...</span>
        </div>

        <div id="predict-error" class="nday-error hidden"></div>

        <div id="predict-results" class="hidden">
            <div class="nday-meta">
                <span id="meta-days"></span>
                <span id="meta-camps"></span>
                <span id="meta-pop"></span>
            </div>

            <div id="predict-cards" class="nday-card-container"></div>

            <table id="predict-table" class="simple-table" style="max-width:700px;">
                <thead>
                    <tr>
                        <th>Resource</th>
                        <th>Predicted Qty</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="predict-tbody"></tbody>
            </table>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 32px 0;">

        <!-- Historical Data Visualization (below predictions) -->
        <h3>Historical Demand Data</h3>

        <div id="matplotlib-section" class="chart-container">
            <h4>Historical Demand Analysis</h4>
            <button id="load-mpl-chart" class="nday-predict-btn" style="margin-bottom: 16px;" onclick="loadMatplotlibChart()">
                Load Historical Chart
            </button>
            <div id="mpl-loader" class="nday-loader hidden">
                <div class="nday-spinner"></div>
                <span>Generating chart...</span>
            </div>
            <div id="mpl-chart-wrapper" class="hidden">
                <img id="mpl-chart-img" class="matplotlib-chart" alt="Historical Demand Chart">
            </div>
        </div>
    </div>

    <script>
        const btn   = document.getElementById('predict-btn');
        const loader = document.getElementById('predict-loader');
        const errorBox = document.getElementById('predict-error');
        const results  = document.getElementById('predict-results');
        const cards    = document.getElementById('predict-cards');
        const tbody    = document.getElementById('predict-tbody');

        const trendIcons = {
            increasing: '&#9650; Increasing',
            decreasing: '&#9660; Decreasing',
            stable:     '&#9644; Stable',
            unknown:    '— Unknown'
        };
        const trendColors = {
            increasing: '#c0392b',
            decreasing: '#27ae60',
            stable:     '#2980b9',
            unknown:    '#888'
        };
        const itemLabels = {
            'food': 'Food (kg)',
            'water': 'Water (ltr)',
            'medicine-kit': 'Med-Kits',
            'other': 'Other'
        };

        // Load Matplotlib chart
        function loadMatplotlibChart() {
            const mplBtn = document.getElementById('load-mpl-chart');
            const mplLoader = document.getElementById('mpl-loader');
            const mplWrapper = document.getElementById('mpl-chart-wrapper');

            mplBtn.disabled = true;
            mplLoader.classList.remove('hidden');
            mplWrapper.classList.add('hidden');

            fetch('/api/nday/chart')
                .then(r => r.json())
                .then(data => {
                    mplLoader.classList.add('hidden');
                    mplBtn.disabled = false;
                    if (data.ok) {
                        document.getElementById('mpl-chart-img').src = 'data:image/png;base64,' + data.chart;
                        mplWrapper.classList.remove('hidden');
                        mplBtn.textContent = 'Refresh Chart';
                    } else {
                        mplBtn.textContent = 'No data available';
                    }
                })
                .catch(err => {
                    mplLoader.classList.add('hidden');
                    mplBtn.disabled = false;
                    console.error('Chart error:', err);
                });
        }

        // Predict
        btn.addEventListener('click', async () => {
            errorBox.classList.add('hidden');
            results.classList.add('hidden');
            loader.classList.remove('hidden');
            btn.disabled = true;

            try {
                const resp = await fetch('/admin/nday/predict', { method: 'POST' });
                const data = await resp.json();

                loader.classList.add('hidden');
                btn.disabled = false;

                if (!data.ok) {
                    errorBox.innerHTML = `<strong>Cannot predict:</strong> ${data.message}`;
                    errorBox.classList.remove('hidden');
                    return;
                }

                document.getElementById('meta-days').textContent  = `Days of data: ${data.days_of_data}`;
                document.getElementById('meta-camps').textContent = `Active camps: ${data.stats.num_camps}`;
                document.getElementById('meta-pop').textContent   = `Total population: ${data.stats.total_pop}`;

                cards.innerHTML = '';
                data.predictions.forEach(p => {
                    const label = itemLabels[p.item_type] || p.item_type;
                    const trendHTML = trendIcons[p.trend] || p.trend;
                    const tColor = trendColors[p.trend] || '#888';
                    cards.innerHTML += `
                        <div class="nday-card">
                            <div class="nday-card-title">${label}</div>
                            <div class="nday-card-value">${p.predicted_qty}</div>
                            <div class="nday-card-trend" style="color:${tColor}">${trendHTML}</div>
                        </div>`;
                });

                tbody.innerHTML = '';
                data.predictions.forEach(p => {
                    const label = itemLabels[p.item_type] || p.item_type;
                    const trendHTML = trendIcons[p.trend] || p.trend;
                    const tColor = trendColors[p.trend] || '#888';
                    tbody.innerHTML += `
                        <tr>
                            <td>${label}</td>
                            <td style="font-weight:700;">${p.predicted_qty}</td>
                            <td style="color:${tColor}">${trendHTML}</td>
                        </tr>`;
                });

                results.classList.remove('hidden');

            } catch (err) {
                loader.classList.add('hidden');
                btn.disabled = false;
                errorBox.innerHTML = `<strong>Error:</strong> ${err.message}`;
                errorBox.classList.remove('hidden');
            }
        });
    </script>

    <script>
        //  TomTom API key
        window.TOMTOM_KEY = "{{ tomtom_key|e }}";
    </script>
    <script src="/static/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
