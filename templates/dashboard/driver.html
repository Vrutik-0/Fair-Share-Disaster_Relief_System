<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps.css">
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps-web.min.js"></script>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/services/services-web.min.js"></script>
    <title>Driver Dashboard</title>
    <style>
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: bold;
        }
        .status-in_transit { background-color: #fff3cd; color: #856404; }
        .status-available { background-color: #d4edda; color: #155724; }
        .status-loading { background-color: #cce5ff; color: #004085; }
        .camp-card {
            border: 3px solid #CBD5E1;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background:#F1F5F9;
        }
        .camp-card.delivered { background: #d4edda; opacity: 0.5; }
        .camp-header { display: flex; justify-content: space-between; align-items: center; }
        .stop-number {
            font-weight: bold;
            font-size: 16px;
        }
        .urgency-high { border-left: 4px solid red;}
        .urgency-medium { border-left: 4px solid orange; }
        .urgency-low { border-left: 4px solid green; }
        .items-table { width: 100%; margin-top: 10px; }
        .items-table th, .items-table td { padding: 5px; text-align: left; }
        .btn-deliver { background-color: #28a745; color: white; }
        .btn-deliver:disabled { background-color: #ccc; cursor: not-allowed; }
        #map { height: 400px; width: 100%; max-width: 600px; border: 2px solid #333; }
        .flash-success { background-color: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .flash-warning { background-color: #fff3cd; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">Fair-Share V1</div>
        <a href="{{ url_for('driver_dashboard') }}" class="sidebar-link active">Dashboard</a>
        <div class="sidebar-bottom">
            <a href="{{ url_for('logout') }}" class="sidebar-link">Logout</a>
        </div>
    </div>

    <!-- Toast -->
    <div id="notif-toasts" class="notif-toast-container"></div>

    <div class="page-content">
        <h2>Driver Dashboard</h2>
        <p>Welcome, <strong>{{ session['name'] }}</strong></p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if truck_number %}
            <div style="margin: 15px 0;">
                <strong>Assigned Truck:</strong> {{ truck_number }}
                <span class="status-badge status-{{ truck_status }}">{{ truck_status or 'N/A' }}</span>
            </div>
        {% else %}
            <p style="color: orange;">No truck assigned to you yet.</p>
        {% endif %}

        <h3>Route Map</h3>

            
        <div class="legend" style=" border: #4f4f4f solid 2px; border-radius: 8px;">
            <span class="legend-item"><span class="legend-color" style="background:blue;"></span> NGO/Warehouse</span>
            <span class="legend-item"><span class="legend-color" style="background:red;"></span> Critical (&ge;0.7)</span>
            <span class="legend-item"><span class="legend-color" style="background:orange;"></span> Moderate (0.4-0.7)</span>
            <span class="legend-item"><span class="legend-color" style="background:green;"></span> Low (&lt;0.4)</span>
        </div>


        <div class="map-notif-row">
            <div id="map"></div>
            <div class="notif-inline-box">
                <div class="notif-inline-header">
                    <span>Notifications</span>
                    <span id="notif-unread-dot" class="notif-unread-dot hidden"></span>
                    <button id="notif-mark-read-inline" class="mark-read-link">Mark all read</button>
                </div>
                <div id="notif-inline-list" class="notif-inline-list">
                    <div class="notif-empty">Loading...</div>
                </div>
            </div>
        </div>

        <h3>Delivery Route</h3>

        {% if camps %}
            {% for camp in camps %}
            <div class="camp-card {% if camp.is_delivered %}delivered{% endif %} 
                        {% if camp.urgency >= 0.7 %}urgency-high{% elif camp.urgency >= 0.4 %}urgency-medium{% else %}urgency-low{% endif %}">
                
                <div class="camp-header">
                    <div>
                        <span class="stop-number">{{ camp.visit_order or loop.index }}</span>
                        <strong style="font-size: 18px; margin-left: 10px;">{{ camp.name }}</strong>
                        <span style="color: gray; font-size: 12px;">(Urgency: {{ "%.2f"|format(camp.urgency) }})</span>
                    </div>
                    
                    {% if not camp.is_delivered and camp.delivery_items %}
                    <form method="POST" action="{{ url_for('mark_camp_delivered', camp_id=camp.camp_id) }}">
                        <button type="submit" class="btn btn-deliver">Mark Delivered</button>
                    </form>
                    {% elif camp.is_delivered %}
                        <span style="color: green; font-weight: bold;">Delivered</span>
                    {% endif %}
                </div>

                {% if camp.delivery_items %}
                <table class="items-table" border="2" cellpadding="5" cellspacing="0" style="border: rgb(103, 103, 103) solid 3px;">
                    <tr >
                        <th>Item</th>
                        <th>Quantity</th>
                    </tr>
                    {% for item in camp.delivery_items %}
                    <tr>
                        <td>{{ item.type }}</td>
                        <td>{{ item.quantity }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                    <p style="color: gray; font-style: italic;">No pending deliveries for this camp.</p>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p>No deliveries assigned to your route.</p>
        {% endif %}
    </div>

    <script>
        const TOMTOM_KEY = '1KePC88rQpaiVRKSJSwCzJmiQE18I29O';

        function gridToLngLat(gridY, gridX) {
            const lat = 22.945 + (gridY * 0.15 / 1000);
            const lng = 72.495 + (gridX * 0.15 / 1000);
            return [lng, lat];
        }

        function createCircleEl(color, size) {
            const el = document.createElement('div');
            el.style.cssText = `width:${size}px;height:${size}px;border-radius:50%;background:${color};border:2px solid ${color};opacity:0.9;cursor:pointer;`;
            return el;
        }

        const map = tt.map({
            key: TOMTOM_KEY,
            container: 'map',
            center: gridToLngLat(500, 500),
            zoom: 10
        });

        map.addControl(new tt.NavigationControl());

        map.on('load', () => {
            fetch("/api/driver-route")
                .then(res => res.json())
                .then(async data => {
                    if (!data.points || data.points.length === 0) {
                        console.log("No route data");
                        return;
                    }

                    // Convert points from [gridY, gridX] to [lng, lat]
                    const lngLatPoints = data.points.map(p => gridToLngLat(p[0], p[1]));

                    // Get real road route from TomTom Routing API
                    let roadCoords = lngLatPoints;
                    try {
                        const locations = lngLatPoints.map(p => `${p[1]},${p[0]}`).join(':');
                        const url = `https://api.tomtom.com/routing/1/calculateRoute/${locations}/json?key=${TOMTOM_KEY}&travelMode=truck&routeType=fastest`;
                        const routeRes = await fetch(url);
                        const routeData = await routeRes.json();
                        if (routeData.routes && routeData.routes.length > 0) {
                            roadCoords = routeData.routes[0].legs.flatMap(leg =>
                                leg.points.map(p => [p.longitude, p.latitude])
                            );
                        }
                    } catch (err) {
                        console.warn("TomTom routing failed, falling back to straight line:", err);
                    }

                    // Draw road-following route line
                    map.addSource('driver-route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: { type: 'LineString', coordinates: roadCoords }
                        }
                    });

                    map.addLayer({
                        id: 'driver-route',
                        type: 'line',
                        source: 'driver-route',
                        paint: {
                            'line-color': 'blue',
                            'line-width': 4,
                            'line-opacity': 0.8
                        }
                    });

                    // Add markers for each point
                    lngLatPoints.forEach((p, i) => {
                        const isDepot = i === 0;
                        const color = isDepot ? 'blue' : 'red';
                        const size = isDepot ? 20 : 16;
                        const el = createCircleEl(color, size);
                        const label = isDepot ? 'NGO / Warehouse' : `Stop ${i}: ${data.camps[i-1]?.name || 'Camp'}`;

                        new tt.Marker({ element: el })
                            .setLngLat(p)
                            .setPopup(new tt.Popup({ offset: 10 }).setText(label))
                            .addTo(map);
                    });

                    // Step number labels at midpoints
                    if (lngLatPoints.length >= 2) {
                        for (let i = 0; i < lngLatPoints.length - 1; i++) {
                            const from = lngLatPoints[i];
                            const to = lngLatPoints[i + 1];
                            const midLng = (from[0] + to[0]) / 2;
                            const midLat = (from[1] + to[1]) / 2;

                            const numEl = document.createElement('div');
                            numEl.style.cssText = 'background:green;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;';
                            numEl.textContent = i + 1;

                            new tt.Marker({ element: numEl })
                                .setLngLat([midLng, midLat])
                                .addTo(map);
                        }
                    }

                    // Fit bounds to show all points
                    if (lngLatPoints.length > 0) {
                        const bounds = new tt.LngLatBounds();
                        lngLatPoints.forEach(p => bounds.extend(p));
                        map.fitBounds(bounds, { padding: 50 });
                    }
                })
                .catch(err => console.error("Error loading route:", err));
        });
    </script>
    <script src="/static/script.js"></script>
</body>
</html>
